<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Audio Reactive Light Beams ‚Äì B/N</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/p5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/addons/p5.sound.min.js"></script>
<style>
  :root{--fg:#e6e6e6;--dim:#8d8d8d}
  html,body{margin:0;height:100%;background:#000;color:var(--fg);font:14px/1.25 system-ui,Segoe UI,Roboto,Arial}
  #ui{
    position:fixed;left:12px;right:12px;bottom:12px;display:flex;gap:10px;flex-wrap:wrap;
    align-items:center;justify-content:center;background:rgba(10,10,10,.66);
    border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:10px;backdrop-filter:blur(6px)
  }
  button,label,input[type="range"]{color:var(--fg);background:#151515;border:1px solid #2a2a2a;border-radius:10px}
  button{padding:.55rem .85rem;cursor:pointer} button:hover{border-color:#444}
  .ctrl{display:flex;align-items:center;gap:6px;background:#101010;padding:.35rem .55rem;border-radius:10px;border:1px solid #222}
  .ctrl input[type="range"]{width:140px}
  .sep{width:1px;height:24px;background:#2a2a2a;margin:0 6px}
  #title{position:fixed;left:12px;top:12px;padding:.4rem .7rem;border-radius:10px;background:rgba(10,10,10,.66);border:1px solid rgba(255,255,255,.08);font-weight:600}
  #status{font-size:12px;color:var(--dim)}
</style>
</head>
<body>
<div id="title">Light Beams ¬∑ B/N</div>
<div id="ui" role="toolbar">
  <button id="play">‚ñ∂Ô∏é Play</button>
  <button id="pause">‚ùö‚ùö Pausa</button>
  <div class="sep"></div>
  <button id="mic">üé§ Microfono</button>
  <label for="file" style="padding:.55rem .85rem;cursor:pointer">üìÇ Carica audio</label>
  <input id="file" type="file" accept="audio/*" style="display:none"/>
  <div class="sep"></div>
  <button id="invert">‚óê Inverti B/N</button>
  <button id="mirror">‚áÑ Mirror</button>
  <div class="sep"></div>
  <div class="ctrl"><span>Fasci</span><input id="beams" type="range" min="12" max="96" value="48"><span id="beamsV">48</span></div>
  <div class="ctrl"><span>Glow</span><input id="glow" type="range" min="0" max="100" value="70"><span id="glowV">0.70</span></div>
  <div class="ctrl"><span>Persistenza</span><input id="trail" type="range" min="0" max="100" value="80"><span id="trailV">0.80</span></div>
  <div class="ctrl"><span>Tilt</span><input id="tilt" type="range" min="-100" max="100" value="20"><span id="tiltV">0.20</span></div>
  <div id="status">pronto</div>
</div>

<script>
let fft, amp, audio, micIn, isPlaying=false, usingMic=false;
let bands=48, invertBW=false, mirrorX=false;
let trail=0.80, glow=0.70, baseTilt=0.20; // 0..1
let fogZ=0;

function setup(){
  const c = createCanvas(windowWidth, windowHeight);
  c.parent(document.body);
  pixelDensity(1);

  fft = new p5.FFT(0.85, 2048);
  amp = new p5.Amplitude(); amp.smooth(0.85);

  const $ = s=>document.querySelector(s);
  $("#play").onclick = async ()=>{
    try{
      await getAudioContext().resume();
      if(audio && !audio.isPlaying()) audio.play();
      isPlaying=true; setStatus("riproduzione attiva");
    }catch(e){ setStatus("errore avvio"); console.error(e); }
  };
  $("#pause").onclick = ()=>{
    if(audio && audio.isPlaying()) audio.pause();
    if(micIn){ micIn.stop(); usingMic=false; }
    isPlaying=false; setStatus("in pausa");
  };
  $("#mic").onclick = async ()=>{
    try{
      await getAudioContext().resume();
      if(audio){ audio.stop(); audio=null; }
      micIn = new p5.AudioIn();
      micIn.start(()=>setStatus("microfono attivo"),
                  e=>{ setStatus("permesso microfono negato"); console.error(e); });
      fft.setInput(micIn); amp.setInput(micIn);
      usingMic=true; isPlaying=true;
    }catch(e){ setStatus("errore microfono"); console.error(e); }
  };
  $("#file").onchange = (ev)=>{
    const f = ev.target.files[0]; if(!f) return;
    if(micIn){ micIn.stop(); usingMic=false; }
    if(audio){ audio.stop(); }
    const url = URL.createObjectURL(f);
    audio = loadSound(url, ()=>{
      fft.setInput(audio); amp.setInput(audio);
      audio.loop(); isPlaying=true; setStatus(`in riproduzione: ${f.name}`);
    }, err=>{ setStatus("caricamento audio fallito"); console.error(err); });
  };
  $("#invert").onclick = ()=> invertBW=!invertBW;
  $("#mirror").onclick = ()=> mirrorX=!mirrorX;

  // sliders
  $("#beams").oninput = e=>{ bands=int(e.target.value); $("#beamsV").textContent=bands; };
  $("#glow").oninput  = e=>{ glow=(+e.target.value)/100; $("#glowV").textContent=glow.toFixed(2); };
  $("#trail").oninput = e=>{ trail=(+e.target.value)/100; $("#trailV").textContent=trail.toFixed(2); };
  $("#tilt").oninput  = e=>{ baseTilt=(+e.target.value)/100; $("#tiltV").textContent=baseTilt.toFixed(2); };
}

function windowResized(){ resizeCanvas(windowWidth, windowHeight); }
function setStatus(s){ document.getElementById("status").textContent=s; }

function draw(){
  // persistence / fade
  const base = invertBW ? 255 : 0;
  noStroke(); fill(base, base, base, 255*(1.0-trail)); rect(0,0,width,height);

  const spectrum = fft.analyze(); // 0..255
  const low  = fft.getEnergy(20,140)/255;
  const mid  = fft.getEnergy(140,2000)/255;
  const high = fft.getEnergy(2000,8000)/255;
  const level = amp.getLevel();

  // subtle fog background (adds atmosphere)
  fogZ += 0.001 + level*0.02;
  drawFog(0.05 + 0.25*glow);

  // Beams layout: map frequency index -> vertical position.
  // low freq = y near bottom; high freq = y near top.
  const ctx = drawingContext;
  ctx.globalCompositeOperation = invertBW ? 'darken' : 'lighter'; // additive-ish

  const m = 24; // side margins
  for(let i=0;i<bands;i++){
    const fIdx = Math.floor(map(i,0,bands-1, 0, spectrum.length-1));
    const energy = spectrum[fIdx]/255; // 0..1
    // shape params
    const y = lerp(height-m, m, i/(bands-1));     // bottom -> top
    // tilt: bass tilts downward, treble upward (relative to base tilt knob)
    const tilt = baseTilt*2 - 1; // -1..1
    const groupBias = map(i,0,bands-1,-0.7,0.7);  // low bands negative, high bands positive
    const slope = (tilt*0.6 + groupBias)*0.35;    // global + per-band
    // width/intensity scale with energy, a bit with mid band for presence
    const w = (20 + 280*energy) * (0.7 + 0.6*mid);
    const alpha = (invertBW ? 0.85 : 1.0) * (0.12 + 0.88*pow(energy,1.3)) * (0.5+0.5*glow);

    // draw left->right beam
    drawBeam(-width*0.1, y, width*1.1, y + slope*width, w, alpha, invertBW);
    if(mirrorX){
      // mirror right->left
      drawBeam(width*1.1, y, -width*0.1, y - slope*width, w, alpha*0.9, invertBW);
    }
  }

  // vignette for cinematic contrast
  drawVignette(0.65 + 0.25*(1-glow));
  // film grain
  addGrain(0.05 + 0.08*glow);

  if(!isPlaying){
    push(); noStroke(); fill(invertBW?20:235); textAlign(CENTER,CENTER); textSize(14);
    text("Clicca Play e attiva Microfono o Carica audio", width/2, height-28); pop();
  }
}

// ---- visuals helpers ----
function drawBeam(x1,y1,x2,y2,thickness,alpha,invert){
  const ctx = drawingContext;
  const grad = ctx.createLinearGradient(x1,y1,x2,y2);
  const colA = invert ? 0 : 255;
  const colB = invert ? 255 : 0;
  // soft core + glow falloff
  grad.addColorStop(0.00, `rgba(${colA},${colA},${colA},${alpha*0.00})`);
  grad.addColorStop(0.35, `rgba(${colA},${colA},${colA},${alpha*0.55})`);
  grad.addColorStop(0.50, `rgba(${colA},${colA},${colA},${alpha*1.00})`);
  grad.addColorStop(0.65, `rgba(${colA},${colA},${colA},${alpha*0.55})`);
  grad.addColorStop(1.00, `rgba(${colA},${colA},${colA},${alpha*0.00})`);
  ctx.strokeStyle = grad;
  ctx.lineWidth = thickness;
  ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke();
}

function drawVignette(strength){
  const g = drawingContext.createRadialGradient(
    width/2,height/2, min(width,height)*0.3,
    width/2,height/2, max(width,height)*0.75
  );
  const a = 0.25*strength;
  const base = invertBW ? 255 : 0, top = invertBW ? 0 : 255;
  g.addColorStop(0, `rgba(${base},${base},${base},0.00)`);
  g.addColorStop(1, `rgba(${top},${top},${top},${0.85*a})`);
  drawingContext.globalCompositeOperation = invertBW ? 'lighten' : 'multiply';
  drawingContext.fillStyle = g;
  noStroke(); rect(0,0,width,height);
}

function drawFog(intensity){
  // big, slow perlin fog blended to add depth
  const step = 4; // coarse to be cheap
  loadPixels();
  let idx=0, t = millis()*0.00008;
  for(let y=0;y<height;y+=step){
    for(let x=0;x<width;x+=step){
      const n = noise(x*0.002, y*0.002, fogZ)*2-1; // -1..1
      const v = (n*intensity*255);
      const col = invertBW ? (255 - v) : (v);
      // fill small block
      for(let dy=0;dy<step && y+dy<height;dy++){
        let start = ((y+dy)*width + x)*4;
        for(let dx=0;dx<step && x+dx<width;dx++){
          pixels[start + dx*4 + 0] = clamp255((pixels[start + dx*4 + 0]||0) + col*0.02);
          pixels[start + dx*4 + 1] = clamp255((pixels[start + dx*4 + 1]||0) + col*0.02);
          pixels[start + dx*4 + 2] = clamp255((pixels[start + dx*4 + 2]||0) + col*0.02);
          // alpha left as-is
        }
      }
    }
  }
  updatePixels();
}

function addGrain(intensity){
  const ctx = drawingContext;
  const img = ctx.getImageData(0,0,width,height);
  const d = img.data;
  for(let i=0;i<d.length;i+=4){
    const g = (Math.random()*2-1)*(intensity*255);
    d[i] = clamp255(d[i]+g);
    d[i+1] = clamp255(d[i+1]+g);
    d[i+2] = clamp255(d[i+2]+g);
  }
  ctx.putImageData(img,0,0);
}
function clamp255(v){ return v<0?0:(v>255?255:v); }
</script>
</body>
</html>
